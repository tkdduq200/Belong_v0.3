{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <h2>ğŸ“ˆ ê³ ë…ì‚¬ ì˜ˆì¸¡</h2>
    <hr>

    <form method="POST">
        <div class="row">
            <div class="col-md-4">
                <label>ìì¹˜êµ¬ ì„ íƒ</label>
                <select name="gu" class="form-control">
                    {% for r in regions %}
                        <option value="{{ r }}" {% if prediction and prediction.gu == r %}selected{% endif %}>
                            {{ r }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                <label>ì—°ë„ ì„ íƒ</label>
                <select name="year" class="form-control">
                    {% for y in years %}
                        <option value="{{ y }}" {% if prediction and prediction.year == y %}selected{% endif %}>
                            {{ y }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary w-100">ì˜ˆì¸¡í•˜ê¸°</button>
            </div>
        </div>
    </form>

    <hr>

    {% if prediction %}
    <div class="alert alert-info mt-3">
        <strong>ì˜ˆì¸¡ ê²°ê³¼:</strong><br>
        ğŸ“ <b>{{ prediction.gu }}</b> â€” <b>{{ prediction.year }}</b>ë…„<br>
        ğŸ”® ì˜ˆì¸¡ ê°’: <b>{{ prediction.predicted_value | round(2) }}</b> ëª…<br>
        {% if prediction.actual_value %}
            ğŸ“Œ ì‹¤ì œ ê°’: <b>{{ prediction.actual_value }}</b> ëª…
        {% endif %}
        {% if from_cache %}
            <span class="badge bg-success">DB Cache</span>
        {% else %}
            <span class="badge bg-primary">New Prediction</span>
        {% endif %}
    </div>
    {% endif %}

    {% if prediction %}
    <h4 class="mt-4">ğŸ“Š ì‹œê°í™” ê²°ê³¼</h4>

    <canvas id="predictionChart" width="400" height="200"></canvas>

    <!-- Jinja ë°ì´í„°ë¥¼ JSON ì•ˆì „ ë¸”ë¡ìœ¼ë¡œ ì „ë‹¬ -->
    <script type="application/json" id="chart-data">
        {
            "labels": ["ì‹¤ì œê°’", "ì˜ˆì¸¡ê°’"],
            "values": [
                {{ prediction.actual_value if prediction.actual_value else "null" }},
                {{ prediction.predicted_value | round(2) }}
            ]
        }
    </script>

    {% raw %}
    <script>
        const rawJson = document.getElementById("chart-data").textContent;
        const chartData = JSON.parse(rawJson);

        const ctx = document.getElementById('predictionChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'ê³ ë…ì‚¬ ì¸ì› ìˆ˜',
                    data: chartData.values,
                    backgroundColor: [
                        "rgba(54, 162, 235, 0.5)", 
                        "rgba(255, 99, 132, 0.5)"
                    ],
                    borderColor: [
                        "rgba(54, 162, 235, 1)", 
                        "rgba(255, 99, 132, 1)"
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
    {% endraw %}
    {% endif %}

</div>
{% endblock %}
